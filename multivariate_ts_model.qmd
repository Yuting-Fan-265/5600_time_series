---
title: "Multivariate TS Models (ARIMAX/SARIMAX/VAR)"
format:  
  html:
    code-fold: true
    embed-resources: true
editor_options: 
  chunk_output_type: console
---
```{r}
#| include: false
library(tidyverse)
library(ggplot2)
library(forecast)
library(astsa) 
library(xts)
library(tseries)
library(fpp2)
library(fma)
library(lubridate)
library(TSstudio)
library(quantmod)
library(tidyquant)
library(plotly)
library(gridExtra)               
library(zoo) 
library(vars)  
library(dplyr)
```

## Literature Review

In analyzing the temporal dynamics of the U.S. freight transportation industry, key variables emerge as critical factors shaping its trajectory. Economic indicators, encompassing metrics like GDP growth, consumer spending, and industrial production, serve as pivotal markers of overall economic activity. These indicators not only influence freight transportation demand but also offer insights into broader economic trends. Additionally, fuel prices wield significant influence, affecting operating costs and modal choice decisions within the transportation sector. Research underscores the impact of fuel price fluctuations on transportation costs, suggesting their inclusion as exogenous variables in ARIMAX models to enhance freight volume forecasts.

When considering modeling approaches, both ARIMAX and VAR models offer distinct advantages for capturing the complexities of freight transportation dynamics. ARIMAX models are well-suited for incorporating economic indicators, fuel prices, and infrastructure investment as variables. Leveraging their autoregressive and exogenous components, ARIMAX models can effectively account for temporal patterns and external influences, thereby improving the accuracy of freight volume forecasts over time. On the other hand, VAR models excel in analyzing the dynamic relationships among multiple variables. They provide a versatile framework for examining the simultaneous effects of economic indicators, fuel prices, regulatory changes, and technological advancements on freight transportation dynamics. With their capacity to capture intricate interactions and feedback mechanisms, VAR models offer valuable insights into the evolving landscape of the freight transportation industry.

In my ARIMAX/SARIMAX model, I've chosen to focus on two key datasets. Firstly, the COVID-19 pandemic has reshaped societal norms significantly, leading to notable shifts in consumer behaviors and lifestyle patterns. With restrictions in place and mobility constrained, there has been a substantial surge in demand for delivery services. UPS, as a prominent player in the U.S. delivery service sector, has been instrumental in meeting this increased demand. My goal is to examine whether there exists a relationship between the number of new COVID-19 cases and UPS stock prices. To accomplish this, I will employ an ARIMAX model to delve into the dynamics between these variables and discern any potential impact of the pandemic on UPS stock performance.

Secondly, fuel prices play a pivotal role in the freight industry, exerting a significant influence on operational costs. I aim to investigate whether fluctuations in fuel prices affect freight values, particularly within the international freight sector. Additionally, I aim to assess the potential impact of the Transportation Services Index (TSI) on freight values. To explore these relationships comprehensively, I intend to utilize the SARIMAX model. This model facilitates the analysis of time series data while accounting for external factors such as fuel prices and the TSI. Through this analysis, I seek to gain insights into the interplay between fuel prices, the TSI, and the values of Canadian freight in the U.S. landscape. 

For the VAR model, the analysis delves into three distinct sets of variables within the air cargo industry to uncover their interrelationships and implications. Firstly, it examines the connections between Air Cargo (Domestic), Air Cargo (International), Fuel Price, and the Transportation Services Index (TSI). This investigation aims to discern whether fluctuations in air cargo volumes, both domestically and internationally, correlate with changes in fuel prices and TSI, thereby providing insights into the broader drivers of the air cargo industry.

Secondly, the analysis focuses on the relationship between Air Cargo (Domestic), Air Cargo (International), and Employment. By exploring the mutual influence between air cargo volumes and employment levels. Understanding these dynamics is crucial for grasping the industry's labor market dynamics and its broader economic implications.

Lastly, the analysis considers the dynamics between GDP, Revenue, and Employment within the air industry. By examining the interplay between these key economic indicators, it aims to uncover the industry's economic performance and its effects on employment trends. This exploration provides valuable insights into the industry's contribution to the broader economy and its role in shaping employment patterns.

## Define Models

### ARIMAX: UPS Stock Price ~ Covid New Cases (Weekly)
```{r}
#  ARIMAX: ups stock price and covid new cases (weekly)
# get the weekly stock price of ups
ups <- getSymbols("UPS",auto.assign = FALSE, from = "2020-01-01", to = "2023-05-15",src="yahoo") 
ups=data.frame(ups)
ups <- data.frame(ups,rownames(ups))
colnames(ups)[7] = "date"
ups$date<-as.Date(ups$date,"%Y-%m-%d")
ups <- ups[seq(1, nrow(ups), by = 5), ]

# get the weekly covid new cases
covid <- read.csv("data/clean_data/covid.csv",header =TRUE, sep = ',')
covid <- subset(covid, select = c(date, new_cases_per_million))
covid <- na.omit(covid)
covid <- head(covid, -6)
covid$new_cases_per_million[covid$new_cases_per_million == 0.000] <- 0.001

# combine the data
ups_covid <- data.frame("UPS"=log(ups$UPS.Adjusted), "COVID"=log(covid$new_cases_per_million))
#(head(ups_covid))

# Convert to a Time Series Component 
ups_covid_ts <- ts(ups_covid, start = decimal_date(as.Date("2020-01-02", format = "%Y-%m-%d")), frequency = 52)

head(ups_covid_ts)

#VARselect(ups_covid_ts, lag.max=10, type="both")
#summary(vars::VAR(ups_covid_ts, p=3, type='both'))
```

### SARIMAX: Canada Freight Value ~ Fuel Price + TSI (Monthly)
```{r}
#  SARIMAX: Canada Freight Value and Fuel Price, TSI (monthly)
# get the canada freight monthly value
canada <- read.csv("data/clean_data/24monthly_canada_freight.csv")
canada <- canada[,c("Date","Value")]

# get the fuel monthly price
fuel <- read.csv("data/clean_data/34monthly_fuel_prices.csv")
# remove the dollar sign
fuel$Diesel <- as.numeric(gsub("\\$", "", fuel$Diesel))
fuel$Jet.Fuel <- as.numeric(gsub("\\$", "", fuel$Jet.Fuel))
# select the same start data
fuel1 <- fuel[73:(nrow(fuel)-6),]

# get the TSI monthly data
tsi <- read.csv("data/clean_data/35monthly_TSI.csv")
tsi1 <- tsi[73:nrow(tsi),]

# combine the data
canada_value <- data.frame("Canada_value"=canada$Value, "Fuel"=fuel1$Diesel, "TSI"=tsi1$Transportation.Services.Index...Freight)
#(head(canada_value))

canada_value_ts <- ts(canada_value, start = decimal_date(as.Date("2006-01-01", format = "%Y-%m-%d")), frequency = 12)

head(canada_value_ts)

#VARselect(canada_value_ts, lag.max=10, type="both")
#summary(vars::VAR(canada_value_ts, p=2, type='both'))
```

###  VAR: Air Cargo(Domestic) ~ Air Cargo(International) + Fuel Price + TSI (Monthly) 
```{r}
#  VAR: Air Cargo and Fuel Price, TSI (monthly)
# get the cargo data
cargo <- read.csv("data/clean_data/Monthly_air_revenue.csv")
cargo$International <- cargo$U.S..Air.Carrier.Cargo..millions.of.revenue.ton.miles....International/1000000000
cargo$Domestic <- cargo$U.S..Air.Carrier.Cargo..millions.of.revenue.ton.miles....Domestic/1000000000
cargo <- cargo[4:(nrow(cargo)-8),]

# get the fuel monthly price
fuel <- read.csv("data/clean_data/34monthly_fuel_prices.csv")
# remove the dollar sign
fuel$Diesel <- as.numeric(gsub("\\$", "", fuel$Diesel))
fuel$Jet.Fuel <- as.numeric(gsub("\\$", "", fuel$Jet.Fuel))
# select the same start data
fuel2 <- fuel[37:(nrow(fuel)-6),]

# get the TSI monthly data
tsi <- read.csv("data/clean_data/35monthly_TSI.csv")
tsi2 <- tsi[37:nrow(tsi),]

# combine the data
revenue_ <- data.frame("Domestic"=cargo$Domestic, "International"=cargo$International, "Fuel"=fuel2$Jet.Fuel, "TSI"=tsi2$Transportation.Services.Index...Freight)
#(head(revenue_))

revenue_ts <- ts(revenue_, start = decimal_date(as.Date("2003-01-01", format = "%Y-%m-%d")), frequency = 12)

head(revenue_ts)
```

### VAR: Employment ~ Air Cargo(Domestic) + Air Cargo(International) (Monthly) 
```{r}
#  VAR: Employment and Air Cargo (monthly)
# get the employment data
employment <- read.csv("data/clean_data/32monthly_employment.csv")
employment <- employment[,c("Date","Transportation.Employment...Air.Transportation")]

# get the cargo data
cargo <- read.csv("data/clean_data/Monthly_air_revenue.csv")
cargo$International <- cargo$U.S..Air.Carrier.Cargo..millions.of.revenue.ton.miles....International/1000000000
cargo$Domestic <- cargo$U.S..Air.Carrier.Cargo..millions.of.revenue.ton.miles....Domestic/1000000000
cargo1 <- cargo[28:(nrow(cargo)-8),]

# combine the data
emp_ <- data.frame("Employment"=employment$Transportation.Employment...Air.Transportation, "International"=cargo1$International, "Domestic"=cargo1$Domestic)
#(head(emp_))

emp_ts <- ts(emp_, start = decimal_date(as.Date("2005-01-01", format = "%Y-%m-%d")), frequency = 12)

head(emp_ts)
```

###  VAR: GDP ~ Revenue + Employment (Air, Yearly)
```{r}
#  VAR: Air GDP, Revenue and Employment (yearly)
# get the yearly GDP of air
gdp <- read.csv("data/clean_data/31GDP.csv")
# Group by Year and Mode, calculate the sum of GDP within each group
gdp <- gdp %>%
  filter(Mode =='Air')%>%
  group_by(Year) %>%
  summarize(Value = sum(Current....billions., na.rm = TRUE))

# get the air revenue
air <- read.csv("data/clean_data/33revenue.csv")
air <- air[air$Mode=="Air carrier, domestic",c("Year","Value")]
air <- air[order(air$Year), ]
air <- air[13:nrow(air),]

# get the air employment
employment <- read.csv("data/clean_data/32monthly_employment.csv")
employment <- employment[,c("Date","Transportation.Employment...Air.Transportation")]
employment$Date <- as.POSIXct(employment$Date, format = "%m/%d/%Y %I:%M:%S %p")
employment$Year <- format(employment$Date, "%Y")
employment <- employment %>%
              group_by(Year) %>%
              summarize(Value = sum(Transportation.Employment...Air.Transportation, na.rm = TRUE)/1000000)
employment <- employment[8:17,]

# combine the data
air_ <- data.frame("GDP"=gdp$Value, "Revenue"=air$Value, "Employment"=employment$Value)
#(head(air_))

air_ts <- ts(air_, start = decimal_date(as.Date("2012-01-01", format = "%Y-%m-%d")), frequency = 1)

(air_ts)
```



## ARIMAX/SARIMAX

### Select Variables
::: panel-tabset

### UPS Stock Price ~ Covid New Cases
```{r}
#| warning: false
#ups_covid_ts
autoplot(ups_covid_ts, facets = T) +
  labs(x="Date", y="", title = "UPS Stock Price and Covid New Cases")

```

The COVID-19 pandemic has been a profound influence on society, dramatically altering people's lifestyles and behaviors. With restrictions in place and mobility limited, there has been a significant surge in demand for delivery services. UPS, as a leading company in the delivery service sector in the U.S., stands at the forefront of meeting this increased demand. I aim to investigate whether there is a relationship between the number of new COVID-19 cases and UPS stock prices. To do this, I will utilize an ARIMAX model to explore the dynamics between these variables and discern any potential impact of the pandemic on UPS stock performance.
 

### Canada Freight Value ~ Fuel Price + TSI

```{r}
#| warning: false
#canada_value_ts
autoplot(canada_value_ts, facets = T) +
  labs(x="Date", y="", title = "Canada Freight Value and Fuel Price and TSI")
```

Fuel prices play a crucial role in the freight industry, significantly impacting operational costs. I aim to investigate whether fluctuations in fuel prices influence freight values, particularly in the international freight sector. Additionally, I seek to understand the potential impact of the Transportation Services Index (TSI) on freight values. To explore these relationships, I plan to utilize the SARIMAX model, which allows for the analysis of time series data while considering exogenous variables such as fuel prices and the TSI. By examining these dynamics, I hope to gain insights into the interplay between fuel prices, the TSI, and the Canada freight values in the U.S..

:::


### Auto.Arima()
::: panel-tabset

### UPS Stock Price ~ Covid New Cases
```{r}
#| warning: false
#ups_covid_ts
fit0 <- auto.arima(ups_covid_ts[,'UPS'], xreg=ups_covid_ts[,'COVID'])
summary(fit0)

checkresiduals(fit0)
```

Select model: Regression with ARIMA(0,1,0)(1,0,0)[52] errors. 

### Canada Freight Value ~ Fuel Price + TSI

```{r}
#| warning: false
#canada_value_ts
xreg <- cbind(fuel = canada_value_ts[, "Fuel"],
              tsi = canada_value_ts[, "TSI"])
fit0 <- auto.arima(canada_value_ts[,'Canada_value'], xreg=xreg)
summary(fit0)

checkresiduals(fit0)
```

Select model: Regression with ARIMA(1,0,0)(1,0,0)[12] errors.
:::


### Manual Method
::: panel-tabset

### UPS Stock Price ~ Covid New Cases
```{r}
#| warning: false
#ups_covid_ts
fit.reg1 <- lm(UPS ~ COVID, data=ups_covid_ts)
summary(fit.reg1)
```

COVID is significant.

```{r}
res.fit1<-ts(residuals(fit.reg1),star=decimal_date(as.Date("2020-01-02",format = "%Y-%m-%d")),frequency = 52)

ggtsdisplay(res.fit1)
```

The data is not stationary, it needs differencing.

```{r}
ggtsdisplay(diff(res.fit1))
```

p=2,3,d=1,q=2,3,P=1,D=0,Q=0

```{r}
SARIMA.c=function(p1,p2,q1,q2,P1,P2,Q1,Q2,data){
  
  temp=c()
  d=0
  D=0
  s=52
  
  i=1
  temp= data.frame()
  ls=matrix(rep(NA,9*150),nrow=150)
  
  
  for (p in p1:p2)
  {
    for(q in q1:q2)
    {
      for(P in P1:P2)
      {
        for(Q in Q1:Q2)
        {
          if(p+d+q+P+D+Q<=10)
          {
            
            model<- Arima(data,order=c(p-1,d,q-1),seasonal=c(P-1,D,Q-1))
            ls[i,]= c(p-1,d,q-1,P-1,D,Q-1,model$aic,model$bic,model$aicc)
            i=i+1
            #print(i)
            
          }
          
        }
      }
    }
    
  }
  
  temp= as.data.frame(ls)
  names(temp)= c("p","d","q","P","D","Q","AIC","BIC","AICc")
  
  temp
  
}

# p=2,3,d=1,q=2,3,P=1,D=0,Q=0

output=SARIMA.c(p1=1,p2=4,q1=1,q2=3,P1=1,P2=1,Q1=1,Q2=1,data=res.fit1)
#output

output[which.min(output$AIC),] 
output[which.min(output$BIC),]
output[which.min(output$AICc),]
```

Best models: ARIMA(3,0,2)x(0,0,0)[52], auto.arima suggested: ARIMA(0,1,0)(1,0,0)[52]

Model diagnostics to compare the two models.

Model1: ARIMA(3,0,2)x(0,0,0)[52]
```{r}
# model1: ARIMA(3,0,2)x(0,0,0)[52]
set.seed(1234)
model_output12 <- capture.output(sarima(res.fit1, 3,0,2, 0,0,0,52)) 
cat(model_output12[105:116], model_output12[length(model_output12)], sep = "\n")
```

Model2: ARIMA(0,1,0)(1,0,0)[52]
```{r}
# model2: ARIMA(0,1,0)(1,0,0)[52]
set.seed(1234)
model_output12 <- capture.output(sarima(res.fit1, 0,1,0, 1,0,0,52)) 
cat(model_output12[20:27], model_output12[length(model_output12)], sep = "\n")
```

The Standard Residual Plot both appears to have some irregularities in the mean and variation.

The Autocorrelation Function (ACF) plot model1 shows almost no correlation indicating that the model has harnessed everything and all that is left is white noise. This indicates a good model fit. model2 shows some correlations left.

The Quantile-Quantile (Q-Q) Plot both shows near normality.

The Ljung-Box test results model1 reveal values above the 0.05 (5% significance) threshold, indicating a good fit.

$ttable: All coefficients are significant below a 0.05 threshold except one in model1.

When comparing the two model diagnostics, the manual model is better, which was Regression with ARIMA(3,0,2)(0,0,0)[52] errors.
 

### Canada Freight Value ~ Fuel Price + TSI

```{r}
#| warning: false
#canada_value_ts
fit.reg <- lm( Canada_value ~ Fuel+ TSI, data=canada_value_ts)
summary(fit.reg)
```

Fuel and TSI both be significant.

```{r}
res.fit<-ts(residuals(fit.reg),star=decimal_date(as.Date("2006-01-01",format = "%Y-%m-%d")),frequency = 12)

ggtsdisplay(res.fit)
```

The data is not stationary, it needs differencing.

```{r}
ggtsdisplay(diff(res.fit, lag=12))
```

p=1,d=0,q=1,2,3,P=1,2,D=1,Q=1

```{r}
SARIMA.c=function(p1,p2,q1,q2,P1,P2,Q1,Q2,d1,d2,data){
  
  temp=c()
  d=0
  D=1
  s=12
  
  i=1
  temp= data.frame()
  ls=matrix(rep(NA,9*150),nrow=150)
  
  
  for (p in p1:p2)
  {
    for(q in q1:q2)
    {
      for(P in P1:P2)
      {
        for(Q in Q1:Q2)
        {
          for(d in d1:d2)
       
        {
          if(p+d+q+P+D+Q<=10)
          {
            
            model<- Arima(data,order=c(p-1,d,q-1),seasonal=c(P-1,D,Q-1))
            ls[i,]= c(p-1,d,q-1,P-1,D,Q-1,model$aic,model$bic,model$aicc)
            i=i+1
            #print(i)
            
          }
          
        }
      }
    }
    
  }
  
  }
  temp= as.data.frame(ls)
  names(temp)= c("p","d","q","P","D","Q","AIC","BIC","AICc")
  
  temp
  
}

# p=1,d=0,q=1,2,3,P=1,2,D=1,Q=1

output=SARIMA.c(p1=1,p2=2,q1=1,q2=2,P1=1,P2=3,Q1=1,Q2=2,d1=0,d2=1,data=res.fit)
#output

output[which.min(output$AIC),] 
output[which.min(output$BIC),]
output[which.min(output$AICc),]
```

Best models: ARIMA(1,0,0)x(2,1,1)[12], auto.arima suggested: ARIMA(1,0,0)(1,0,0)[12]

Model diagnostics to compare the two models.

Model1: ARIMA(1,0,0)x(2,1,1)[12]
```{r}
# model1: ARIMA(1,0,0)x(2,1,1)[12]
set.seed(1234)
model_output12 <- capture.output(sarima(res.fit, 1,0,0, 2,1,1,12)) 
cat(model_output12[30:40], model_output12[length(model_output12)], sep = "\n")
```

Model2: ARIMA(1,0,0)x(1,0,0)[12]
```{r}
# model2: ARIMA(1,0,0)x(1,0,0)[12]
set.seed(1234)
model_output12 <- capture.output(sarima(res.fit, 1,0,0, 1,0,0,12)) 
cat(model_output12[41:49], model_output12[length(model_output12)], sep = "\n")
```

The Standard Residual Plot both appears to have some irregularities in the mean and variation.

The Autocorrelation Function (ACF) plot model1 shows almost no correlation indicating that the model has harnessed everything and all that is left is white noise. This indicates a good model fit. model2 shows some correlations left.

The Quantile-Quantile (Q-Q) Plot both shows near normality.

The Ljung-Box test results model1 reveal values above the 0.05 (5% significance) threshold, indicating a good fit.

$ttable: All coefficients are significant below a 0.05 threshold.

When comparing the two model diagnostics, the manual model is better, which was Regression with ARIMA(1,0,0)(2,1,1)[12] errors.
:::


### Cross-Validation
::: panel-tabset

### UPS Stock Price ~ Covid New Cases
```{r}
#| warning: false
#ups_covid_ts
n=length(res.fit1) #170  156
k=52

 #n-k=104; 104/52=2;

res <- res.fit1[1:156] 
rmse1 <- matrix(NA, 2,52)
rmse2 <- matrix(NA, 2,52)

st <- tsp(res.fit1)[1]+(k-1)/52 

for(i in 1:2)
{
  xtrain <- window(res.fit1, end=st + i-1)
  xtest <- window(res.fit1, start=st + (i-1) + 1/52, end=st + i)
  
  #models:  ARIMA(0,1,0)x(1,0,0)[52]. and ARIMA(3,0,2)(0,0,0)[52]
  
  fit <- Arima(xtrain, order=c(0,1,0), seasonal=list(order=c(1,0,0), period=52),
                include.drift=TRUE, method="ML")
  fcast <- forecast(fit, h=52)
  
  fit2 <- Arima(xtrain, order=c(3,0,2), seasonal=list(order=c(0,0,0), period=52),
                include.drift=TRUE, method="ML")
  fcast2 <- forecast(fit2, h=52)
  
  

  rmse1[i,1:length(xtest)]  <- sqrt((fcast$mean-xtest)^2)
  rmse2[i,1:length(xtest)] <- sqrt((fcast2$mean-xtest)^2)

  
}

plot(1:52, colMeans(rmse1,na.rm=TRUE), type="l", col=2, xlab="horizon", ylab="RMSE")
lines(1:52, colMeans(rmse2,na.rm=TRUE), type="l",col=3)

legend("topleft",legend=c("fit1: auto.arima model","fit2: manual model"),col=2:3,lty=1)
```

The auto.arima model had lower RMSE compared to the manual model. Therefore, the best model is ARIMA(0,1,0)(1,0,0)[52].

### Canada Freight Value ~ Fuel Price + TSI

```{r}
#| warning: false
#canada_value_ts
n=length(res.fit) #205  204
k=48

 #n-k=156; 156/12=13;

res <- res.fit[1:204] 
rmse1 <- matrix(NA, 13,12)
rmse2 <- matrix(NA, 13,12)

st <- tsp(res.fit)[1]+(k-1)/12 

for(i in 1:13)
{
  xtrain <- window(res.fit, end=st + i-1)
  xtest <- window(res.fit, start=st + (i-1) + 1/12, end=st + i)
  
  #models:  ARIMA(1,0,0)x(1,0,0)[12]. and ARIMA(1,0,0)(2,1,1)[12]
  
  fit <- Arima(xtrain, order=c(1,0,0), seasonal=list(order=c(1,0,0), period=12),
                include.drift=TRUE, method="ML")
  fcast <- forecast(fit, h=12)
  
  fit2 <- Arima(xtrain, order=c(1,0,0), seasonal=list(order=c(2,1,1), period=12),
                include.drift=TRUE, method="ML")
  fcast2 <- forecast(fit2, h=12)
  
  

  rmse1[i,1:length(xtest)]  <- sqrt((fcast$mean-xtest)^2)
  rmse2[i,1:length(xtest)] <- sqrt((fcast2$mean-xtest)^2)

  
}

plot(1:12, colMeans(rmse1,na.rm=TRUE), type="l", col=2, xlab="horizon", ylab="RMSE")
lines(1:12, colMeans(rmse2,na.rm=TRUE), type="l",col=3)

legend("topleft",legend=c("fit1: auto.arima model","fit2: manual model"),col=2:3,lty=1)
```

The manual model had lower RMSE compared to the auto.arima model. Therefore, the best model is ARIMA(1,0,0)(2,1,1)[12].

:::


### Model Fitting
::: panel-tabset

### UPS Stock Price ~ Covid New Cases
```{r}
#| warning: false
#ups_covid_ts
fit <- Arima(ups_covid_ts[,'UPS'], order=c(0,1,0), seasonal=c(1,0,0), xreg=ups_covid_ts[,'COVID'])
summary(fit)
```

**Equation:**  $y_t = -0.0008x_t + (1-B)n_t + (1-0.0795B) z_t$ 

### Canada Freight Value ~ Fuel Price + TSI

```{r}
#| warning: false
#canada_value_ts
xreg <- cbind(fuel = canada_value_ts[, "Fuel"],
              tsi = canada_value_ts[, "TSI"])
fit0 <- Arima(canada_value_ts[,'Canada_value'], order=c(1,0,0), seasonal=c(2,1,1), xreg=xreg)
summary(fit0)
```

**Equation:**  $y_t =  0.0601x_t{fuel} + 0.3302x_t{tsi} + \phi(B) \Phi(B^{12}) (1-B^{12})n_t + \Theta (B^{12}) z_t$

$\phi(B) = 1 - 0.7016B$

$\Phi(B^s) = 1 - 0.1968B^{12} + 0.2513B^{24}$

$\Theta (B^s) = 1 + 0.8508B^{12}$

:::


### Forecast
::: panel-tabset

### UPS Stock Price ~ Covid New Cases
```{r}
#| warning: false
#ups_covid_ts
covid_fit <- auto.arima(ups_covid_ts[,'COVID'])
fcov <- forecast(covid_fit, 52)

fcast <- forecast(fit, xreg=fcov$mean,52) 
autoplot(fcast, main="Forecast of UPS Stock Price for the next year") + xlab("Year") +
  ylab("UPS Stock Price")
```

The forecast of the UPS stock price appears to be relatively flat, indicating that the model may not adequately capture the fluctuations observed in the original data.


### Canada Freight Value ~ Fuel Price + TSI

```{r}
#| warning: false
#canada_value_ts
fuel_fit <- auto.arima(canada_value_ts[,'Fuel'])
ffuel <- forecast(fuel_fit, 36)
tsi_fit <- auto.arima(canada_value_ts[,'TSI'])
ftsi <- forecast(tsi_fit, 36)

fxreg <- cbind(fuel = ffuel$mean, tsi = ftsi$mean) 
fcast <- forecast(fit0, xreg=fxreg,36) 
autoplot(fcast, main="Forecast of Canada Freight Value for the next three years") + xlab("Year") +
  ylab("Canada Freight Value")
```

The trend of the Canada freight value is observed to be decreasing, and the model appears to capture the seasonal fluctuations present in the original data.
:::

### Findings

For the UPS stock price and COVID-19 new cases, there appears to be a correlation between the two variables, with the UPS stock price showing an increase alongside the rise in COVID-19 new cases. However, since the COVID-19 pandemic ended in 2023, the UPS stock price is predicted to remain relatively flat with a slight decrease.

Regarding the Canada freight value, both the fuel price and TSI exhibit correlations with the freight value, showcasing seasonal fluctuations. The trend of the Canada freight value over the next three years is expected to decrease.



## VAR

### Select Variables
::: panel-tabset

### Air Cargo(Domestic) ~ Air Cargo(International) + Fuel Price + TSI
```{r}
#| warning: false
#revenue_ts
autoplot(revenue_ts, facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Air Cargo(Domestic), Air Cargo(International), Fuel Price and TSI in USA")
```

I have selected Air Cargo (Domestic), Air Cargo (International), Fuel Price, and TSI as variables for analysis. My objective is to explore the interdependencies among these variables. Specifically, I aim to understand whether there is a mutual influence between domestic and international air cargo, whether fuel prices affect air cargo volumes, and whether the TSI correlates with the other variables. By examining the relationships among these variables, I hope to gain insights into the dynamics of the air cargo industry and its drivers.

### Employment ~ Air Cargo(Domestic) + Air Cargo(International)

```{r}
#| warning: false
#emp_ts
autoplot(emp_ts, facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Employment, Air Cargo(Domestic) and Air Cargo(International) in USA")
```

I have selected Air Cargo (Domestic), Air Cargo (International), and Employment as variables for analysis. My goal is to examine the potential mutual influence among these variables. Specifically, I aim to understand whether changes in domestic and international air cargo volumes impact employment levels, and vice versa. This analysis will help me understand the interconnectedness of these factors and their implications for economic activity and employment trends.

### VAR: GDP ~ Revenue + Employment (Air)
```{r}
#| warning: false
#air_ts
autoplot(air_ts, facets=TRUE) +
  xlab("Year") + ylab("") +
  ggtitle("Air GDP, Revenue and Employment in USA")
```

My objective is to explore the potential interrelationships among these variables. Specifically, I aim to understand how changes in GDP and Revenue within the air industry may influence employment levels, and vice versa. By investigating the relationships among these key indicators, I seek to gain insights into the dynamics of the air industry's economic performance and its impact on employment trends.

:::


### Select Best VAR(p)
::: panel-tabset

### Air Cargo(Domestic) ~ Air Cargo(International) + Fuel Price + TSI

Based on the selection criterion, models with lag orders p=3 and p=10 were considered. Upon fitting VAR(1), VAR(3), and VAR(10) models and comparing the results, it was observed that the VAR(10) model will be instability. Meanwhile, the VAR(3) model showed stronger correlations among the variables, indicating its potential as the best-fitting model.

```{r}
#| warning: false
#revenue_ts

VARselect(revenue_ts, lag.max=10, type="both")
summary(vars::VAR(revenue_ts, p=1, type='both'))
summary(vars::VAR(revenue_ts, p=3, type='both'))
summary(vars::VAR(revenue_ts, p=10, type='both'))
```

### Employment ~ Air Cargo(Domestic) + Air Cargo(International)

Based on the selection criterion, models with lag orders p=3, p=4 and p=10 were considered. Upon fitting VAR(1), VAR(3), and VAR(4) models and comparing the results, it was observed that the VAR(10) model will be instability. Meanwhile, the VAR(3) model showed stronger correlations among the variables, indicating its potential as the best-fitting model.

```{r}
#| warning: false
#emp_ts


VARselect(emp_ts, lag.max=10, type="both")
summary(vars::VAR(emp_ts, p=1, type='both'))
summary(vars::VAR(emp_ts, p=3, type='both'))
summary(vars::VAR(emp_ts, p=4, type='both'))
```

### VAR: GDP ~ Revenue + Employment (Air)

Based on the selection criterion, models with lag orders p=1, and p=2 were considered. Upon fitting VAR(1), and VAR(2) models and comparing the results, it was observed that the model showed no stronger correlations among the variables, indicating VAR(1) as the best-fitting model.

```{r}
#| warning: false
#air_ts

VARselect(air_ts, lag.max=5, type="both")
summary(vars::VAR(air_ts, p=1, type='both'))
#summary(vars::VAR(air_ts, p=2, type='both'))
```

:::


### Cross Validation
::: panel-tabset

### Air Cargo(Domestic) ~ Air Cargo(International) + Fuel Price + TSI
```{r}
#| warning: false
#revenue_ts

n=240
k=48 #12*4

#n-k=192; 192/12=16;

rmse1 <- matrix(NA, 192,4) #here is n-k
rmse2 <- matrix(NA, 192,4)
rmse3 <- matrix(NA,16,12) #here n-k / 12 
year<-c()

ts_obj1 <- head(revenue_ts, -1)

st <- tsp(ts_obj1 )[1]+(k-1)/12 


for(i in 1:16) #here  is (n-k ) / 12
{
  
  xtrain <- window(ts_obj1, end=st + i-1)
  xtest <- window(ts_obj1, start=st + (i-1) + 1/12, end=st + i)
  
  ######## first Model ############
  fit <- vars::VAR(xtrain, p=4, type='both')
  fcast <- predict(fit, newdata=xtest, n.ahead = 12)
  fdo<-fcast$fcst$Domestic
  fin<-fcast$fcst$International
  ffuel<-fcast$fcst$Fuel
  ftsi <-fcast$fcst$TSI
  
  ff<-data.frame(fdo[,1],fin[,1],ffuel[,1],ftsi[,1]) #collecting the forecasts for 4 variables
  
  year<-st + (i-1) + 1/12 #starting year
  
  ####### convert to a time series object ########
  
  ff<-ts(ff,start=c(year,1),frequency = 12)
  
  a = 12*i-11 #going from 1,13, 15, (1,1+12,1+12+12, 1+12+12+12, ...)
  b= 12*i #12, 24, 36
  
  ##### collecting errors ######
  rmse1[c(a:b),]  <-sqrt((ff-xtest)^2)
  
  
  ######## Second Model ############
  fit2 <- vars::VAR(xtrain, p=3, type='both')
  fcast2 <- predict(fit2, newdata=xtest, n.ahead = 12)
  
  fdo<-fcast2$fcst$Domestic
  fin<-fcast2$fcst$International
  ffuel<-fcast2$fcst$Fuel
  ftsi <-fcast2$fcst$TSI
  
  ff2<-data.frame(fdo[,1],fin[,1],ffuel[,1],ftsi[,1])
  
  year<-st + (i-1) + 1/12
  
  ff2<-ts(ff2,start=c(year,1),frequency = 12)
  
  a = 12*i-11
  b= 12*i
  rmse2[c(a:b),]  <-sqrt((ff2-xtest)^2)
}

yr = rep(c(2008:2023),each =12) #year
qr = rep(paste0("M",1:12),16) #monthly

rmse1 = data.frame(yr,qr,rmse1)
names(rmse1) =c("Year", "Month", "Domestic", "International", "Fuel", "TSI")
rmse2 = data.frame(yr,qr,rmse2)
names(rmse2) =c("Year", "Month", "Domestic", "International", "Fuel", "TSI")

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = Domestic),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = Domestic),color = "red") +
  labs(
    title = "CV RMSE for Domestic",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = International),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = International),color = "red") +
  labs(
    title = "CV RMSE for International",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = Fuel),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = Fuel),color = "red") +
  labs(
    title = "CV RMSE for Fuel",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = TSI),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = TSI),color = "red") +
  labs(
    title = "CV RMSE for TSI",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))
```

Based on cross-validation results, it was found that the VAR(3) model exhibits a lower RMSE compared to the VAR(4) model. This lower RMSE indicates that the VAR(3) model provides better predictive performance and is therefore considered the superior model in this context.

### Employment ~ Air Cargo(Domestic) + Air Cargo(International)

```{r}
#| warning: false
#emp_ts
n=217
k=48 #12*4

#n-k=168; 168/12=14;

rmse1 <- matrix(NA, 168,3) #here is n-k
rmse2 <- matrix(NA, 168,3)
rmse3 <- matrix(NA,14,12) #here n-k / 12 
year<-c()

ts_obj2 <- head(emp_ts, -1)

st <- tsp(ts_obj2 )[1]+(k-1)/12 


for(i in 1:14) #here  is (n-k ) / 12
{
  
  xtrain <- window(ts_obj2, end=st + i-1)
  xtest <- window(ts_obj2, start=st + (i-1) + 1/12, end=st + i)
  
  ######## first Model ############
  fit <- vars::VAR(xtrain, p=3, type='both')
  fcast <- predict(fit, newdata=xtest, n.ahead = 12)
  fin<-fcast$fcst$International
  fdo<-fcast$fcst$Domestic
  femp<-fcast$fcst$Employment
  
  ff<-data.frame(fin[,1],fdo[,1],femp[,1]) #collecting the forecasts for 3 variables
  
  year<-st + (i-1) + 1/12 #starting year
  
  ####### convert to a time series object ########
  
  ff<-ts(ff,start=c(year,1),frequency = 12)
  
  a = 12*i-11 #going from 1,13, 15, (1,1+12,1+12+12, 1+12+12+12, ...)
  b= 12*i #12, 24, 36
  
  ##### collecting errors ######
  rmse1[c(a:b),]  <-sqrt((ff-xtest)^2)
  
  
  ######## Second Model ############
  fit2 <- vars::VAR(xtrain, p=4, type='both')
  fcast2 <- predict(fit2, newdata=xtest, n.ahead = 12)
  
  fin<-fcast2$fcst$International
  fdo<-fcast2$fcst$Domestic
  femp<-fcast2$fcst$Employment
  ff2<-data.frame(fin[,1],fdo[,1],femp[,1])
  
  year<-st + (i-1) + 1/12
  
  ff2<-ts(ff2,start=c(year,1),frequency = 12)
  
  a = 12*i-11
  b= 12*i
  rmse2[c(a:b),]  <-sqrt((ff2-xtest)^2)
}

yr = rep(c(2010:2023),each =12) #year
qr = rep(paste0("M",1:12),14) #monthly

rmse1 = data.frame(yr,qr,rmse1)
names(rmse1) =c("Year", "Month","International","Domestic","Employment")
rmse2 = data.frame(yr,qr,rmse2)
names(rmse2) =c("Year", "Month","International","Domestic","Employment")

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = International),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = International),color = "red") +
  labs(
    title = "CV RMSE for International",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = Domestic),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = Domestic),color = "red") +
  labs(
    title = "CV RMSE for Domestic",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = Employment),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = Employment),color = "red") +
  labs(
    title = "CV RMSE for Employment",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))
```

Based on cross-validation results, it was found that the VAR(3) model exhibits a lower RMSE compared to the VAR(4) model. This lower RMSE indicates that the VAR(4) model provides better predictive performance and is therefore considered the superior model in this context.

### VAR: GDP ~ Revenue + Employment (Air)
```{r}
#| warning: false
#air_ts
n=10 #372
k=1 #12*4

#n-k=9; 

rmse1 <- matrix(NA, 9,3) #here is n-k
rmse2 <- matrix(NA, 9,3)
rmse3 <- matrix(NA,9) #here n-k
year<-c()

ts_obj <- air_ts

st <- tsp(ts_obj )[1] 


for(i in 1:9) #here  is (n-k ) 
{
  
  xtrain <- window(ts_obj, end=st + i-1)
  xtest <- window(ts_obj, start=st + (i-1) + 1, end=st + i)
  
  ######## first Model ############
  fit <- vars::VAR(ts_obj, p=1, type='both')
  fcast <- predict(fit, n.ahead = 3)
  fgdp<-fcast$fcst$GDP
  fre<-fcast$fcst$Revenue
  femp<-fcast$fcst$Employment
  
  ff<-data.frame(fgdp[,1],fre[,1],femp[,1]) #collecting the forecasts for 3 variables
  
  year<-st + (i-1) #starting year
  
  ####### convert to a time series object ########
  
  ff<-ts(ff,start=c(year,1),frequency = 1)
  
  ##### collecting errors ######
  rmse1[i-1,]  <-sqrt((ff-xtest)^2)
  
  
  ######## Second Model ############
  fit2 <- vars::VAR(ts_obj, p=2, type='both')
  fcast2 <- predict(fit2, n.ahead = 3)
  
  fgdp<-fcast2$fcst$GDP
  fre<-fcast2$fcst$Revenue
  femp<-fcast2$fcst$Employment
  ff2<-data.frame(fgdp[,1],fre[,1],femp[,1])
  
  year<-st + (i-1)
  
  ff2<-ts(ff2,start=c(year,1),frequency = 1)
  
  rmse2[i-1,]  <-sqrt((ff2-xtest)^2)
}

yr = rep(c(2013:2021),each =1) #year

rmse1 = data.frame(yr,rmse1)
names(rmse1) =c("Year", "GDP","Revenue","Employment")
rmse2 = data.frame(yr,rmse2)
names(rmse2) =c("Year", "GDP","Revenue","Employment")

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = GDP),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = GDP),color = "red") +
  labs(
    title = "CV RMSE for GDP",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = Revenue),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = Revenue),color = "red") +
  labs(
    title = "CV RMSE for Revenue",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

ggplot() + 
  geom_line(data = rmse1, aes(x = Year, y = Employment),color = "blue") +
  geom_line(data = rmse2, aes(x = Year, y = Employment),color = "red") +
  labs(
    title = "CV RMSE for Employment",
    x = "Date",
    y = "RMSE",
    guides(colour=guide_legend(title="Fit")))

```

Based on cross-validation results, it was found that the VAR(1) model exhibits a lower RMSE compared to the VAR(2) model. This lower RMSE indicates that the VAR(1) model provides better predictive performance and is therefore considered the superior model in this context.

:::


### Forecast
::: panel-tabset

### Air Cargo(Domestic) ~ Air Cargo(International) + Fuel Price + TSI

The most optimal model I fitted is the VAR(3) model.
```{r}
#| warning: false
#revenue_ts
var <- vars::VAR(ts_obj1, p=3, type='both')

forecast(var) %>%
  autoplot() + xlab("Year")
```

The forecast of the variables appears to capture the trend of the original data adequately. While the fuel trend shows a slight decrease, the trends in other variables appear relatively stable or flat. Furthermore, the model seems to struggle in capturing the seasonality present in the data.


### Employment ~ Air Cargo(Domestic) + Air Cargo(International)

The most optimal model I fitted is the VAR(4) model.

```{r}
#| warning: false
#emp_ts
var <- vars::VAR(ts_obj2, p=4, type='both')

forecast(var) %>%
  autoplot() + xlab("Year")
```

The forecast of the variables appears to capture the trend of the original data adequately. While the employment trend shows a decreasing trend, the trends in other variables exhibit fluctuations, with an initial increase followed by a subsequent drop. However, it seems that the model struggles to capture the seasonality present in the data.


### VAR: GDP ~ Revenue + Employment (Air)

The most optimal model I fitted is the VAR(1) model.
```{r}
#| warning: false
#air_ts
var <- vars::VAR(ts_obj, p=1, type='both')

forecast(var) %>%
  autoplot() + xlab("Year")
```

The forecast of the variables does not appear to capture the trend of the original data adequately. All the variables exhibit fluctuations, characterized by an initial increase followed by a subsequent drop, which repeats over time. Additionally, the model diagnostics show no significant correlation among the variables, suggesting that the model performance may not be optimal.

:::

### Findings

The first model appears to capture the trend of the original data adequately. While the fuel trend shows a slight decrease, the trends in other variables appear relatively stable or flat. Furthermore, the model seems to struggle in capturing the seasonality present in the data.

The second model appears to capture the trend of the original data adequately. While the employment trend shows a decreasing trend, the trends in other variables exhibit fluctuations, with an initial increase followed by a subsequent drop. However, it seems that the model struggles to capture the seasonality present in the data.

The third model does not appear to capture the trend of the original data adequately. All the variables exhibit fluctuations, characterized by an initial increase followed by a subsequent drop, which repeats over time. Additionally, the model diagnostics show no significant correlation among the variables, suggesting that the model performance may not be optimal.